const restify = require('restify');
const builder = require('botbuilder');
const config =  require('./config.js');
const users =   require("./appconfig.json");

let model = 'https://westus.api.cognitive.microsoft.com/luis/v2.0/apps/899a5581-0c98-4e96-a389-13a6080eabf8?subscription-key=9c2eaf8becea42ef9a98c0d7e22ffa65&verbose=true&q=';



//Create a server

let server = restify.createServer();
let port = process.env.port||process.env.PORT||3978;
server.listen(port,()=>{
    console.log("Bot Server Started  at port %d ", port);
});


// Create Intital Chat Bot 

let connectionConfigation = new builder.ChatConnector({
    appId:config.appId,
    appPassword:config.appPassword

});


let bot =  new builder.UniversalBot(connectionConfigation);

let recognizer = new builder.LuisRecognizer(model);

server.post("/api/messages",connectionConfigation.listen());


let dialog = new builder.IntentDialog({
    recognizers :[recognizer]
});

bot.dialog('/',dialog);


//Set up intent handling of the bot

dialog.matches('intent.BeginConversation', [
    (session)=>{
        session.send("All good");
    }
] );

dialog.matches("BeginConversation",'/start');
dialog.matches('MissedTechnician','/missedtechnician');
dialog.matches('ScheduleTechnician','/schedule');
dialog.onDefault('/default');


bot.dialog("/default",[
    (session)=>{
        session.sendTyping();
        session.send("I am sorry I don't understand your question, please try rephrase it");
    }
]);

bot.dialog('/start', [
    (session,args,next)=>{
        if(!session.userData.accountNo){
            session.sendTyping();
            session.beginDialog("/profile");
        }else{
            next();
        }
    },
    (session)=>{
        session.sendTyping();
        session.send("Welcome back Mr %s <br> How can I help \
        you today", session.userData.name);
    }
]);


/*
 * Handle Missed appointment 
 * 
 * 
 */

bot.dialog("/missedtechnician",[
    (session,args,next)=>{
         console.log(session.userData);
         if(!session.userData.accountNo){
            session.beginDialog("/profile");
        }else{
            session.sendTyping();
            next();
        }
    },
    (session,results)=>{
        session.send("Hello %s <br> I am really sorry to hear that \
        , let me look into it",session.userData.name);
        session.sendTyping();
        let schedule = pullschedule(session.userData.accountNo);
        if(schedule!==null){
            // Call pointis to get the action;
            session.send("Apologies, I found that you had an appointment \
            on %s at %s but we failed as %s",schedule.appoitmentDate,schedule.appoitmentTime,schedule.issuetag);
            session.sendTyping();

        }
    } 
    
]);


/*
 * Handle the schedule new appoitment 
 * 
 * 
 * 
 */ 
bot.dialog("/schedule", [
    (session)=>{
        session.send("Working on create a appoitment for you");
    }
]);





// Root Dialog for bot
/*bot.dialog("/",[
    (session,args,next)=>{
        if(!session.userData.accountNumber){
            session.beginDialog("/profile");
        }else{
            next();
        }
    },
    (session,results)=>{
        session.send("Hello %s",session.userData.name);
    }
]);*/

// Take the NXT account number and pin in this dialog and look up user account and authenticate user and set up his name in session;
bot.dialog("/profile", [
    (session)=>{
        builder.Prompts.text(session,"Kindly provide your 8 git NXT account number");
    },
    (session,results,next)=>{
        session.userData.accountNo = results.response;
        session.userData.name =  lookUPAccount(results.response).name;
        next();
    },
    (session)=>{
        builder.Prompts.number(session,"Kindly provide 4 digit account pin");
    },
    (session,results)=>{
        session.userData.accountPin = results.response;
        session.endDialog("Thank you, We are validating your account, please wait...")
    },
])

lookUPAccount = function(accountNo) {
        // Lets keep dummy for demo else will be consuming rest end point 
        return {
            name:"Atin Singh"
        } 

}

pullschedule = function(accountNo) {
        users.forEach((account)=>{
            if(account.accountNumber===accountNo){
                return account;
            }
        })
        return null;
}